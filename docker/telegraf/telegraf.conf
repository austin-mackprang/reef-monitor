# Telegraf Configuration for Neptune Apex (XML Parser)

[agent]
  interval = "${COLLECTION_INTERVAL}s"
  round_interval = true
  metric_batch_size = 1000
  metric_buffer_limit = 10000
  collection_jitter = "0s"
  flush_interval = "10s"
  flush_jitter = "0s"
  precision = "0s"
  hostname = "apex-telegraf"
  omit_hostname = false

# Output to InfluxDB v2
[[outputs.influxdb_v2]]
  urls = ["http://influxdb:8086"]
  token = "${INFLUXDB_TOKEN}"
  organization = "${INFLUXDB_ORG}"
  bucket = "${INFLUXDB_BUCKET}"

# Input from Neptune Apex status.xml
[[inputs.http]]
  urls = ["${APEX_ENDPOINT}"]
  interval = "${COLLECTION_INTERVAL}s"
  timeout = "30s"
  method = "GET"
  data_format = "xpath_json"

  # Parse probe values from the XML
  [[inputs.http.xpath]]
    metric_name = "apex_probe"
    metric_selection = "/status/probes/probe"
    timestamp_format = "unix"

    [inputs.http.xpath.tags]
      probe_name = "string(/name)"
      probe_type = "string(/type)"

    [inputs.http.xpath.fields]
      value = "number(/value)"

  # Parse outlet states from the XML
  [[inputs.http.xpath]]
    metric_name = "apex_outlet"
    metric_selection = "/status/outlets/outlet"

    [inputs.http.xpath.tags]
      outlet_name = "string(/name)"
      device_id = "string(/deviceID)"

    [inputs.http.xpath.fields_int]
      output_id = "/outputID"
      state = "string(/state)"

  # Parse system metadata from the XML
  [[inputs.http.xpath]]
    metric_name = "apex_system"
    metric_selection = "/status"

    [inputs.http.xpath.tags]
      hostname = "string(/hostname)"
      software = "string(@software)"
      hardware = "string(@hardware)"
      serial = "string(/serial)"

    [inputs.http.xpath.fields]
      timezone = "number(/timezone)"
